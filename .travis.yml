language: python
sudo: required
python:
  - 3.6
services: postgresql

env:
  - DJANGO_SETTINGS_MODULE=iati.settings.test

install:
  - pip install -r iati/requirements_dev.txt
  - psql -c "CREATE DATABASE travisci;" -U postgres  # Must match DB name in iati.settings.dev
  - python iati/manage.py makemigrations_translation
  - python iati/manage.py migrate_translation --no-input
before_script:
  - python iati/manage.py runserver &
script:
  - make -C iati test

stages:
  - strict lint
  - test

jobs:
  include:
    - stage: test
      install:
        - pip install -r iati/requirements_dev.txt
        - psql -c "CREATE DATABASE travisci;" -U postgres  # Must match DB name in iati.settings.dev
        - python iati/manage.py makemigrations_translation
        - python iati/manage.py migrate_translation --no-input
      before_script:
        - python iati/manage.py runserver &
      script: make -C iati test
    - stage: strict lint
      install:
        - pip install -r iati/requirements_dev.txt
      env: LINTER=pylint
      script: make -C iati pylint
      if: branch IN (master, dev)
    - stage: strict lint
      install:
        - pip install -r iati/requirements_dev.txt
      env: LINTER=flake8
      script: make -C iati flake8
      if: branch IN (master, dev)
    - stage: strict lint
      install:
        - pip install -r iati/requirements_dev.txt
      env: LINTER=pydocstyle
      script: make -C iati pydocstyle
      if: branch IN (master, dev)